language: node_js

node_js: "0.10"

cache: true

branches:
  only:
    - master

# The path for Xunit to output test reports
env:
  global:
    - XUNIT_FILE=shippable/testresults/result.xml
    - secure: Qs9bhPFIdHh5xXlzvlmAcP5DHGaU/3Jb3DVk3aqhmJjbj1C4e854vwuCQv3vliyJQ2tf2xmiPp4pNKoJGj8vzt9T/aXZCg65t6J/EWDPQBlfE57e1AmEz/wfVdz5nYjHpZmeiByPciuiAsEFTNFculnh3dPvunMrIiD6tNCEY5glbB+C1KphVJZRrftRBP80/LJlYL/rGAv6Fmbwa7+OOlk2g1QnTtqqak7DNEozmOcZ+xBgJ1EYuHi7+ZRhHA19VpRtf2ciQgCK6/ymweBRDCeDrpXEspQioletyWc71FiDxNNJyJrcs11oG1OM8GrFhQJghNqNeqqpDkqAhcdbqA==

# Notification
notifications:
  email:
    recipients:
      - arielschiavoni@gmail.com
    on_success: change
    on_failure: always

# Create directories for test and coverage reports
before_script:
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage

# Running the tests with npm
script:
  - npm test

# Tell istanbul to generate a coverage report
after_script:
  - cp ./test/result.xml shippable/testresults/result.xml
  - cp ./coverage/cobertura-coverage.xml shippable/codecoverage/

after_success:
  # send notification
  - >
    BUILD_SUCCESSFUL="{
      \"attachments\": [{
        \"fallback\": \"Build successful\",
        \"pretext\": \"Build successful\",
        \"color\": \"good\",
        \"fields\": [{
          \"title\": \"Shippable\",
          \"value\": \"<"$BUILD_URL"|Build #"$BUILD_NUMBER" on "$BRANCH">\",
          \"short\": false
        }, {
          \"title\": \"Github\",
          \"value\": \"<https://github.com/arielschiavoni/commonjsify/commit/"$COMMIT"|Changes>\",
          \"short\": false
        }]
      }]
    }"
  - >
    curl -H "Content-type: application/json"
    -X POST
    -d "$BUILD_SUCCESSFUL"
    https://frontendside.slack.com/services/hooks/incoming-webhook?token=$SLACK_COMMONJSIFY_TOKEN

after_failure:
  # send notification
  - >
    BUILD_FAILED="{
      \"attachments\": [{
        \"fallback\": \"Build failed\",
        \"pretext\": \"Build failed\",
        \"color\": \"danger\",
        \"fields\": [{
          \"title\": \"Shippable\",
          \"value\": \"<"$BUILD_URL"|Build #"$BUILD_NUMBER" on "$BRANCH">\",
          \"short\": false
        }, {
          \"title\": \"Github\",
          \"value\": \"<https://github.com/arielschiavoni/commonjsify/commit/"$COMMIT"|Changes>\",
          \"short\": false
        }]
      }]
    }"
  - >
    curl -H "Content-type: application/json"
    -X POST
    -d "$BUILD_FAILED"
    https://frontendside.slack.com/services/hooks/incoming-webhook?token=$SLACK_COMMONJSIFY_TOKEN
